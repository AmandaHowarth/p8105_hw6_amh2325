---
title: "HW6"
author: "Amanda Howarth"
date: "11/23/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(tidyverse)
library(purrr)
library(broom)
library(modelr)
library(mgcv)
library(patchwork)
```

## Importing data
```{r}
birthweight = read_csv("./data/birthweight.csv")
```
```{r}
birthweight_clean = birthweight %>% 
  janitor::clean_names() %>% 
  mutate(babysex = factor(babysex, levels = c("1", "2")),
         frace = factor(frace, levels = c("1", "2", "3", "4", "8", "9")),
         mrace = factor(mrace, levels = c("1", "2", "3", "4", "8", "9")),
         malform = factor(malform, levels = c("0", "1")),
         babysex = recode(babysex, "1" = "male", "2" = "female"), 
         frace = recode(frace, "1" = "white", "2" = "black", "3" = "asian", "4" = "puerto rican", "8" = "other", "9" = "unknown"),
         mrace = recode(mrace, "1" = "white", "2" = "black", "3" = "asian", "4" = "puerto rican", "8" = "other", "9" = "unknown"), 
         malform = recode(malform, "0" = "absent", "1" = "present")) %>%
  rename(bwt_grams = bwt, mom_weight_lbs = delwt, family_income = fincome, father_race = frace, mom_race = mrace, ges_age_weeks = gaweeks, age_menarche = menarche, mom_height = mheight, mom_age = momage, mom_pre_bmi = ppbmi)
```

## Model building
I have hypothesized that a baby's physical and biological characteristics as well as the mother's physical and biological characteristics at the time of delivery would affect the baby's weight at birth. Thus, in building my model I analyzed baby's sex, head circumference, baby length, gestational age, and presence of malformations that would affect weight. Additionally, I analyzed mother's weight, age at delivery, and height. 

* say that u removed some bc it did not increase in the R^2 
* say looked at all of them first and then chose significant ones 
* say teh R^2 value 
* reisduals ? predictions? 
* removed malform bc not significant 

```{r}
fit_bwt_model = lm(bwt_grams ~ babysex + bhead + blength + mom_weight_lbs + ges_age_weeks, data = birthweight_clean)

fit_bwt_model %>% 
  broom::tidy() %>% 
  knitr::kable()

fit_bwt_model %>%
  broom::glance() %>% 
  knitr::kable()
```

Show a plot of model residuals against fitted values â€“ use add_predictions and add_residuals in making this plot.
```{r}
birthweight_clean %>% 
  modelr::add_residuals(fit_bwt_model) %>% 
  modelr::add_predictions(fit_bwt_model) %>% 
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(
    y = "Residuals", 
    x = "Predicted values of Birthweight", 
    title = "Residuals Plotted Against Birthweight"
    
  )
```

## Model using using length at birth and gestational age as predictors (main effects only)

```{r}
sample_model_1 = lm(bwt_grams ~  blength + ges_age_weeks, data = birthweight_clean)

sample_model_1 %>% 
  broom::tidy() %>% 
  knitr::kable()

sample_model_1 %>% 
  broom::glance() %>% 
  knitr::kable()
```

## Model using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}
sample_model_2 = lm(bwt_grams ~ bhead + blength + babysex + bhead*blength + bhead*babysex + babysex*blength + bhead*blength*babysex, data = birthweight_clean)

sample_model_2 %>% 
  broom::tidy() %>% 
  knitr::kable()

sample_model_2 %>% 
  broom::glance() %>% 
  knitr::kable()
```

## Cross Validation 

```{r}
cv_df = 
  crossv_mc(birthweight_clean, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble)
         ) %>% 
  mutate(fit_bwt_model = map(train, ~lm(bwt_grams ~ babysex + bhead + blength + mom_weight_lbs + ges_age_weeks, data = .x)), 
         sample_model_1= map(train, ~lm(bwt_grams ~ blength + ges_age_weeks, data = .x)),
         sample_model_2= map(train, ~lm(bwt_grams ~ bhead + blength + babysex + bhead*blength + bhead*babysex + babysex*blength + bhead*blength*babysex, data = .x))) %>%
  mutate(rmse_1 = map2_dbl(fit_bwt_model, test, ~rmse(model = .x, data = .y)),
         rmse_2 = map2_dbl(sample_model_1, test, ~rmse(model = .x, data = .y)),
         rmse_3 = map2_dbl(sample_model_2, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(
    y = "Root Mean Squared Errors", 
    x = "Models", 
    title = "Root Mean Squared Errors (RMSE's) Across Models"
  )

```

## Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

```
